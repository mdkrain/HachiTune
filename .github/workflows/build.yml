name: Build Pitch Editor

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  ONNX_VERSION: "1.18.0"

jobs:
  # ============================================
  # Windows CPU Build
  # ============================================
  build-windows-cpu:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Cache JUCE
      id: cache-juce
      uses: actions/cache@v3
      with:
        path: pitch_editor_juce/JUCE
        key: juce-windows-${{ hashFiles('pitch_editor_juce/CMakeLists.txt') }}
    
    - name: Clone JUCE
      if: steps.cache-juce.outputs.cache-hit != 'true'
      run: |
        cd pitch_editor_juce
        git clone --depth 1 --branch 7.0.9 https://github.com/juce-framework/JUCE.git
    
    - name: Download ONNX Runtime CPU
      run: |
        cd pitch_editor_juce
        Invoke-WebRequest -Uri "https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ONNX_VERSION }}/onnxruntime-win-x64-${{ env.ONNX_VERSION }}.zip" -OutFile "onnxruntime.zip"
        Expand-Archive -Path "onnxruntime.zip" -DestinationPath "."
        Rename-Item "onnxruntime-win-x64-${{ env.ONNX_VERSION }}" "onnxruntime"
    
    - name: Download PC-NSF-HiFiGAN Model
      run: |
        cd pitch_editor_juce
        mkdir -p models
        Invoke-WebRequest -Uri "https://github.com/openvpi/vocoders/releases/download/nsf-hifigan-44.1k-hop512-128bin-2024.02/nsf_hifigan_44.1k_hop512_128bin_2024.02.onnx" -OutFile "models/pc_nsf_hifigan.onnx"
    
    - name: Configure CMake
      run: |
        cd pitch_editor_juce
        cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DONNXRUNTIME_ROOT="./onnxruntime"
    
    - name: Build
      run: |
        cd pitch_editor_juce
        cmake --build build --config ${{ env.BUILD_TYPE }}
    
    - name: Package
      run: |
        cd pitch_editor_juce
        mkdir -p package/PitchEditor-Windows-CPU
        cp build/${{ env.BUILD_TYPE }}/PitchEditor.exe package/PitchEditor-Windows-CPU/ 2>$null; if (-not $?) { cp build/PitchEditor_artefacts/${{ env.BUILD_TYPE }}/PitchEditor.exe package/PitchEditor-Windows-CPU/ }
        cp onnxruntime/lib/onnxruntime.dll package/PitchEditor-Windows-CPU/
        cp -r models package/PitchEditor-Windows-CPU/
        Compress-Archive -Path package/PitchEditor-Windows-CPU -DestinationPath PitchEditor-Windows-CPU.zip
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PitchEditor-Windows-CPU
        path: pitch_editor_juce/PitchEditor-Windows-CPU.zip

  # ============================================
  # Windows DirectML Build
  # ============================================
  build-windows-dml:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Cache JUCE
      id: cache-juce
      uses: actions/cache@v3
      with:
        path: pitch_editor_juce/JUCE
        key: juce-windows-${{ hashFiles('pitch_editor_juce/CMakeLists.txt') }}
    
    - name: Clone JUCE
      if: steps.cache-juce.outputs.cache-hit != 'true'
      run: |
        cd pitch_editor_juce
        git clone --depth 1 --branch 7.0.9 https://github.com/juce-framework/JUCE.git
    
    - name: Download ONNX Runtime DirectML
      run: |
        cd pitch_editor_juce
        # Download CPU version for headers
        Invoke-WebRequest -Uri "https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ONNX_VERSION }}/onnxruntime-win-x64-${{ env.ONNX_VERSION }}.zip" -OutFile "onnxruntime-cpu.zip"
        Expand-Archive -Path "onnxruntime-cpu.zip" -DestinationPath "."
        
        # Download DirectML NuGet package
        Invoke-WebRequest -Uri "https://www.nuget.org/api/v2/package/Microsoft.ML.OnnxRuntime.DirectML/${{ env.ONNX_VERSION }}" -OutFile "onnxruntime-dml.nupkg"
        Rename-Item "onnxruntime-dml.nupkg" "onnxruntime-dml.zip"
        Expand-Archive -Path "onnxruntime-dml.zip" -DestinationPath "onnxruntime-dml-nuget"
        
        # Create merged directory with CPU headers and DirectML libs
        mkdir onnxruntime
        cp -r "onnxruntime-win-x64-${{ env.ONNX_VERSION }}/include" onnxruntime/
        mkdir onnxruntime/lib
        cp "onnxruntime-dml-nuget/runtimes/win-x64/native/onnxruntime.dll" onnxruntime/lib/
        cp "onnxruntime-dml-nuget/runtimes/win-x64/native/onnxruntime.lib" onnxruntime/lib/
        
        # Copy DirectML.dll
        cp "onnxruntime-dml-nuget/runtimes/win-x64/native/DirectML.dll" onnxruntime/lib/
    
    - name: Download PC-NSF-HiFiGAN Model
      run: |
        cd pitch_editor_juce
        mkdir -p models
        Invoke-WebRequest -Uri "https://github.com/openvpi/vocoders/releases/download/nsf-hifigan-44.1k-hop512-128bin-2024.02/nsf_hifigan_44.1k_hop512_128bin_2024.02.onnx" -OutFile "models/pc_nsf_hifigan.onnx"
    
    - name: Configure CMake
      run: |
        cd pitch_editor_juce
        cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DONNXRUNTIME_ROOT="./onnxruntime"
    
    - name: Build
      run: |
        cd pitch_editor_juce
        cmake --build build --config ${{ env.BUILD_TYPE }}
    
    - name: Package
      run: |
        cd pitch_editor_juce
        mkdir -p package/PitchEditor-Windows-DirectML
        cp build/${{ env.BUILD_TYPE }}/PitchEditor.exe package/PitchEditor-Windows-DirectML/ 2>$null; if (-not $?) { cp build/PitchEditor_artefacts/${{ env.BUILD_TYPE }}/PitchEditor.exe package/PitchEditor-Windows-DirectML/ }
        cp onnxruntime/lib/onnxruntime.dll package/PitchEditor-Windows-DirectML/
        cp onnxruntime/lib/DirectML.dll package/PitchEditor-Windows-DirectML/
        cp -r models package/PitchEditor-Windows-DirectML/
        Compress-Archive -Path package/PitchEditor-Windows-DirectML -DestinationPath PitchEditor-Windows-DirectML.zip
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PitchEditor-Windows-DirectML
        path: pitch_editor_juce/PitchEditor-Windows-DirectML.zip

  # ============================================
  # macOS Build
  # ============================================
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Cache JUCE
      id: cache-juce
      uses: actions/cache@v3
      with:
        path: pitch_editor_juce/JUCE
        key: juce-macos-${{ hashFiles('pitch_editor_juce/CMakeLists.txt') }}
    
    - name: Clone JUCE
      if: steps.cache-juce.outputs.cache-hit != 'true'
      run: |
        cd pitch_editor_juce
        git clone --depth 1 --branch 7.0.9 https://github.com/juce-framework/JUCE.git
    
    - name: Download ONNX Runtime
      run: |
        cd pitch_editor_juce
        curl -L "https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ONNX_VERSION }}/onnxruntime-osx-universal2-${{ env.ONNX_VERSION }}.tgz" -o onnxruntime.tgz
        tar -xzf onnxruntime.tgz
        mv onnxruntime-osx-universal2-${{ env.ONNX_VERSION }} onnxruntime
    
    - name: Download PC-NSF-HiFiGAN Model
      run: |
        cd pitch_editor_juce
        mkdir -p models
        curl -L "https://github.com/openvpi/vocoders/releases/download/nsf-hifigan-44.1k-hop512-128bin-2024.02/nsf_hifigan_44.1k_hop512_128bin_2024.02.onnx" -o models/pc_nsf_hifigan.onnx
    
    - name: Configure CMake
      run: |
        cd pitch_editor_juce
        cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DONNXRUNTIME_ROOT="./onnxruntime"
    
    - name: Build
      run: |
        cd pitch_editor_juce
        cmake --build build --config ${{ env.BUILD_TYPE }}
    
    - name: Package
      run: |
        cd pitch_editor_juce
        mkdir -p package
        if [ -d "build/PitchEditor_artefacts/${{ env.BUILD_TYPE }}/PitchEditor.app" ]; then
          cp -r "build/PitchEditor_artefacts/${{ env.BUILD_TYPE }}/PitchEditor.app" package/
        elif [ -d "build/PitchEditor.app" ]; then
          cp -r build/PitchEditor.app package/
        fi
        
        # Copy ONNX Runtime dylib into app bundle
        mkdir -p package/PitchEditor.app/Contents/Frameworks
        cp onnxruntime/lib/libonnxruntime*.dylib package/PitchEditor.app/Contents/Frameworks/
        
        # Copy models into app bundle
        mkdir -p package/PitchEditor.app/Contents/Resources/models
        cp models/pc_nsf_hifigan.onnx package/PitchEditor.app/Contents/Resources/models/
        
        # Fix dylib paths
        install_name_tool -add_rpath @executable_path/../Frameworks package/PitchEditor.app/Contents/MacOS/PitchEditor || true
        
        cd package
        zip -r ../PitchEditor-macOS.zip PitchEditor.app
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PitchEditor-macOS
        path: pitch_editor_juce/PitchEditor-macOS.zip

  # ============================================
  # Linux Build
  # ============================================
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libasound2-dev \
          libjack-jackd2-dev \
          libcurl4-openssl-dev \
          libfreetype6-dev \
          libx11-dev \
          libxcomposite-dev \
          libxcursor-dev \
          libxext-dev \
          libxinerama-dev \
          libxrandr-dev \
          libxrender-dev \
          libwebkit2gtk-4.0-dev \
          libglu1-mesa-dev \
          mesa-common-dev
    
    - name: Cache JUCE
      id: cache-juce
      uses: actions/cache@v3
      with:
        path: pitch_editor_juce/JUCE
        key: juce-linux-${{ hashFiles('pitch_editor_juce/CMakeLists.txt') }}
    
    - name: Clone JUCE
      if: steps.cache-juce.outputs.cache-hit != 'true'
      run: |
        cd pitch_editor_juce
        git clone --depth 1 --branch 7.0.9 https://github.com/juce-framework/JUCE.git
    
    - name: Download ONNX Runtime
      run: |
        cd pitch_editor_juce
        curl -L "https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ONNX_VERSION }}/onnxruntime-linux-x64-${{ env.ONNX_VERSION }}.tgz" -o onnxruntime.tgz
        tar -xzf onnxruntime.tgz
        mv onnxruntime-linux-x64-${{ env.ONNX_VERSION }} onnxruntime
    
    - name: Download PC-NSF-HiFiGAN Model
      run: |
        cd pitch_editor_juce
        mkdir -p models
        curl -L "https://github.com/openvpi/vocoders/releases/download/nsf-hifigan-44.1k-hop512-128bin-2024.02/nsf_hifigan_44.1k_hop512_128bin_2024.02.onnx" -o models/pc_nsf_hifigan.onnx
    
    - name: Configure CMake
      run: |
        cd pitch_editor_juce
        cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DONNXRUNTIME_ROOT="./onnxruntime"
    
    - name: Build
      run: |
        cd pitch_editor_juce
        cmake --build build --config ${{ env.BUILD_TYPE }}
    
    - name: Package
      run: |
        cd pitch_editor_juce
        mkdir -p package/PitchEditor-Linux
        
        if [ -f "build/PitchEditor_artefacts/${{ env.BUILD_TYPE }}/PitchEditor" ]; then
          cp "build/PitchEditor_artefacts/${{ env.BUILD_TYPE }}/PitchEditor" package/PitchEditor-Linux/
        elif [ -f "build/PitchEditor" ]; then
          cp build/PitchEditor package/PitchEditor-Linux/
        fi
        
        cp onnxruntime/lib/libonnxruntime.so* package/PitchEditor-Linux/
        cp -r models package/PitchEditor-Linux/
        
        # Create run script
        cat > package/PitchEditor-Linux/run.sh << 'EOF'
        #!/bin/bash
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        export LD_LIBRARY_PATH="$SCRIPT_DIR:$LD_LIBRARY_PATH"
        "$SCRIPT_DIR/PitchEditor" "$@"
        EOF
        chmod +x package/PitchEditor-Linux/run.sh
        chmod +x package/PitchEditor-Linux/PitchEditor
        
        cd package
        tar -czvf ../PitchEditor-Linux.tar.gz PitchEditor-Linux
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PitchEditor-Linux
        path: pitch_editor_juce/PitchEditor-Linux.tar.gz

  # ============================================
  # Create Release
  # ============================================
  release:
    needs: [build-windows-cpu, build-windows-dml, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/PitchEditor-Windows-CPU/PitchEditor-Windows-CPU.zip
          artifacts/PitchEditor-Windows-DirectML/PitchEditor-Windows-DirectML.zip
          artifacts/PitchEditor-macOS/PitchEditor-macOS.zip
          artifacts/PitchEditor-Linux/PitchEditor-Linux.tar.gz
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
