name: Build Pitch Editor

on:
  push:
    branches: [main, master]
    tags:
      - "v*"
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  ONNX_VERSION: "1.17.1"

jobs:
  build-windows-cpu:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v1.1

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      - name: Package
        run: |
          New-Item -ItemType Directory -Force -Path package/PitchEditor-Windows-CPU
          Copy-Item "build/PitchEditor_artefacts/Release/Pitch Editor.exe" -Destination "package/PitchEditor-Windows-CPU/PitchEditor.exe"
          Copy-Item build/PitchEditor_artefacts/Release/*.dll -Destination package/PitchEditor-Windows-CPU/ -ErrorAction SilentlyContinue
          Copy-Item -Recurse build/PitchEditor_artefacts/Release/models -Destination package/PitchEditor-Windows-CPU/ -ErrorAction SilentlyContinue
          Copy-Item -Recurse build/PitchEditor_artefacts/Release/lang -Destination package/PitchEditor-Windows-CPU/ -ErrorAction SilentlyContinue

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PitchEditor-Windows-CPU
          path: package/PitchEditor-Windows-CPU

  build-windows-directml:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v1.1

      - name: Download ONNX Runtime DirectML
        run: |
          # Download CPU version for headers
          Invoke-WebRequest -Uri "https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ONNX_VERSION }}/onnxruntime-win-x64-${{ env.ONNX_VERSION }}.zip" -OutFile "onnxruntime-cpu.zip"
          Expand-Archive -Path "onnxruntime-cpu.zip" -DestinationPath "."
          # Download DirectML version
          Invoke-WebRequest -Uri "https://www.nuget.org/api/v2/package/Microsoft.ML.OnnxRuntime.DirectML/${{ env.ONNX_VERSION }}" -OutFile "onnxruntime-dml.nupkg"
          Rename-Item "onnxruntime-dml.nupkg" "onnxruntime-dml.zip"
          Expand-Archive -Path "onnxruntime-dml.zip" -DestinationPath "onnxruntime-dml-nuget"
          # Download DirectML redistributable
          Invoke-WebRequest -Uri "https://www.nuget.org/api/v2/package/Microsoft.AI.DirectML/1.13.1" -OutFile "directml.nupkg"
          Rename-Item "directml.nupkg" "directml.zip"
          Expand-Archive -Path "directml.zip" -DestinationPath "directml-nuget"
          # Create merged onnxruntime directory
          New-Item -ItemType Directory -Force -Path onnxruntime/lib
          Copy-Item -Recurse "onnxruntime-win-x64-${{ env.ONNX_VERSION }}/include" onnxruntime/
          Copy-Item "onnxruntime-dml-nuget/runtimes/win-x64/native/onnxruntime.dll" onnxruntime/lib/
          Copy-Item "onnxruntime-dml-nuget/runtimes/win-x64/native/onnxruntime.lib" onnxruntime/lib/
          Copy-Item "directml-nuget/bin/x64-win/DirectML.dll" onnxruntime/lib/

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DUSE_DIRECTML=ON -DONNXRUNTIME_ROOT="./onnxruntime"

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      - name: Package
        run: |
          New-Item -ItemType Directory -Force -Path package/PitchEditor-Windows-DirectML
          Copy-Item "build/PitchEditor_artefacts/Release/Pitch Editor.exe" -Destination "package/PitchEditor-Windows-DirectML/PitchEditor.exe"
          Copy-Item onnxruntime/lib/onnxruntime.dll -Destination package/PitchEditor-Windows-DirectML/
          Copy-Item onnxruntime/lib/DirectML.dll -Destination package/PitchEditor-Windows-DirectML/
          Copy-Item -Recurse build/PitchEditor_artefacts/Release/models -Destination package/PitchEditor-Windows-DirectML/ -ErrorAction SilentlyContinue
          Copy-Item -Recurse build/PitchEditor_artefacts/Release/lang -Destination package/PitchEditor-Windows-DirectML/ -ErrorAction SilentlyContinue

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PitchEditor-Windows-DirectML
          path: package/PitchEditor-Windows-DirectML

  build-windows-cuda:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v1.1

      - name: Download ONNX Runtime CUDA
        run: |
          Invoke-WebRequest -Uri "https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ONNX_VERSION }}/onnxruntime-win-x64-gpu-${{ env.ONNX_VERSION }}.zip" -OutFile "onnxruntime-gpu.zip"
          Expand-Archive -Path "onnxruntime-gpu.zip" -DestinationPath "."
          Rename-Item "onnxruntime-win-x64-gpu-${{ env.ONNX_VERSION }}" "onnxruntime"

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DUSE_CUDA=ON -DONNXRUNTIME_ROOT="./onnxruntime"

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      - name: Package
        run: |
          New-Item -ItemType Directory -Force -Path package/PitchEditor-Windows-CUDA
          Copy-Item "build/PitchEditor_artefacts/Release/Pitch Editor.exe" -Destination "package/PitchEditor-Windows-CUDA/PitchEditor.exe"
          Copy-Item onnxruntime/lib/*.dll -Destination package/PitchEditor-Windows-CUDA/
          Copy-Item -Recurse build/PitchEditor_artefacts/Release/models -Destination package/PitchEditor-Windows-CUDA/ -ErrorAction SilentlyContinue
          Copy-Item -Recurse build/PitchEditor_artefacts/Release/lang -Destination package/PitchEditor-Windows-CUDA/ -ErrorAction SilentlyContinue

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PitchEditor-Windows-CUDA
          path: package/PitchEditor-Windows-CUDA

  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libjack-jackd2-dev \
            libcurl4-openssl-dev \
            libfreetype6-dev \
            libx11-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev \
            libxrender-dev \
            libwebkit2gtk-4.0-dev \
            libglu1-mesa-dev \
            mesa-common-dev

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} -j$(nproc)

      - name: Package
        run: |
          mkdir -p package/PitchEditor-Linux
          cp "build/PitchEditor_artefacts/Release/Pitch Editor" package/PitchEditor-Linux/PitchEditor || true
          cp build/PitchEditor_artefacts/Release/*.so* package/PitchEditor-Linux/ 2>/dev/null || true
          cp -r build/PitchEditor_artefacts/Release/models package/PitchEditor-Linux/ 2>/dev/null || true
          cp -r build/PitchEditor_artefacts/Release/lang package/PitchEditor-Linux/ 2>/dev/null || true
          cat > package/PitchEditor-Linux/run.sh << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          export LD_LIBRARY_PATH="$SCRIPT_DIR:$LD_LIBRARY_PATH"
          "$SCRIPT_DIR/PitchEditor" "$@"
          EOF
          chmod +x package/PitchEditor-Linux/run.sh package/PitchEditor-Linux/PitchEditor
          cd package && tar -czvf ../PitchEditor-Linux.tar.gz PitchEditor-Linux

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PitchEditor-Linux
          path: PitchEditor-Linux.tar.gz

  release:
    needs: [build-windows-cpu, build-windows-directml, build-windows-cuda, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          cd artifacts
          [ -d "PitchEditor-Windows-CPU" ] && zip -r PitchEditor-Windows-CPU.zip PitchEditor-Windows-CPU || true
          [ -d "PitchEditor-Windows-DirectML" ] && zip -r PitchEditor-Windows-DirectML.zip PitchEditor-Windows-DirectML || true
          [ -d "PitchEditor-Windows-CUDA" ] && zip -r PitchEditor-Windows-CUDA.zip PitchEditor-Windows-CUDA || true
          [ -d "PitchEditor-Linux" ] && mv PitchEditor-Linux/*.tar.gz . || true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/PitchEditor-Windows-CPU.zip
            artifacts/PitchEditor-Windows-DirectML.zip
            artifacts/PitchEditor-Windows-CUDA.zip
            artifacts/PitchEditor-Linux.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
